<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡∏£‡∏ß‡∏à‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡∏°‡∏™. | ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡∏£‡∏∞‡∏î‡∏∏‡∏°‡∏ó‡∏≠‡∏á‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤</title>
<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&family=Prompt:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
  :root {
    --primary: #1a56a8;
    --primary-dark: #0f3d7a;
    --primary-light: #3b82f6;
    --accent: #0ea5e9;
    --accent-light: #e0f2fe;
    --bg: #f0f6ff;
    --surface: #ffffff;
    --surface2: #f8faff;
    --border: #c7d9f5;
    --text: #1e2d4a;
    --text-muted: #5a7099;
    --danger: #ef4444;
    --success: #10b981;
    --warning: #f59e0b;
    --shadow: 0 4px 20px rgba(26,86,168,0.10);
    --shadow-lg: 0 8px 40px rgba(26,86,168,0.16);
    --radius: 14px;
    --radius-sm: 8px;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Sarabun', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }

  .header {
    background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 60%, var(--accent) 100%);
    padding: 18px 32px; display: flex; align-items: center; gap: 18px;
    box-shadow: 0 4px 24px rgba(10,30,70,0.22); position: sticky; top: 0; z-index: 100;
  }
  .header img { width: 56px; height: 56px; object-fit: contain; border-radius: 50%; background: #fff; padding: 4px; }
  .header-text h1 { font-family: 'Prompt', sans-serif; font-size: 1.15rem; font-weight: 600; color: #fff; line-height: 1.3; }
  .header-text p { font-size: 0.82rem; color: rgba(255,255,255,0.78); margin-top: 2px; }
  .sync-indicator { margin-left: auto; display: flex; align-items: center; gap: 8px; background: rgba(255,255,255,0.12); border-radius: 20px; padding: 6px 14px; font-size: 0.8rem; color: #fff; white-space: nowrap; }
  .sync-dot { width: 8px; height: 8px; border-radius: 50%; background: #4ade80; flex-shrink: 0; transition: background 0.3s; }
  .sync-dot.loading { background: #fbbf24; animation: pulse 1s infinite; }
  .sync-dot.error { background: #f87171; }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.3} }

  .nav { background: var(--surface); border-bottom: 2px solid var(--border); display: flex; padding: 0 32px; overflow-x: auto; }
  .nav-btn { padding: 14px 24px; border: none; background: none; font-family: 'Sarabun', sans-serif; font-size: 0.95rem; font-weight: 500; color: var(--text-muted); cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.2s; white-space: nowrap; display: flex; align-items: center; gap: 8px; }
  .nav-btn:hover { color: var(--primary); background: var(--accent-light); }
  .nav-btn.active { color: var(--primary); border-bottom-color: var(--primary); font-weight: 600; }

  .main { max-width: 1100px; margin: 0 auto; padding: 28px 20px; }
  .card { background: var(--surface); border-radius: var(--radius); box-shadow: var(--shadow); border: 1px solid var(--border); padding: 24px; margin-bottom: 20px; }
  .card-title { font-family: 'Prompt', sans-serif; font-size: 1rem; font-weight: 600; color: var(--primary); margin-bottom: 18px; display: flex; align-items: center; gap: 8px; }
  .card-title::before { content: ''; display: inline-block; width: 4px; height: 18px; background: var(--primary-light); border-radius: 4px; }

  .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 14px; }
  .form-group { display: flex; flex-direction: column; gap: 5px; }
  .form-group label { font-size: 0.82rem; font-weight: 600; color: var(--primary-dark); }
  .form-control { padding: 9px 12px; border: 1.5px solid var(--border); border-radius: var(--radius-sm); font-family: 'Sarabun', sans-serif; font-size: 0.9rem; color: var(--text); background: var(--surface2); transition: border-color 0.2s; width: 100%; }
  .form-control:focus { outline: none; border-color: var(--primary-light); box-shadow: 0 0 0 3px rgba(59,130,246,0.12); background: #fff; }

  .student-table-wrap { overflow-x: auto; }
  .student-table { width: 100%; border-collapse: collapse; font-size: 0.88rem; min-width: 600px; }
  .student-table th { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); color: #fff; padding: 10px; text-align: left; font-weight: 600; font-size: 0.82rem; }
  .student-table th:first-child { border-radius: 8px 0 0 0; } .student-table th:last-child { border-radius: 0 8px 0 0; }
  .student-table td { padding: 7px 8px; border-bottom: 1px solid var(--border); vertical-align: middle; }
  .student-table tr:hover td { background: var(--accent-light); }
  .student-table tr.ms-row td { background: rgba(239,68,68,0.06); }
  .student-table input { border: 1px solid var(--border); border-radius: 5px; padding: 5px 7px; font-family: 'Sarabun', sans-serif; font-size: 0.87rem; width: 100%; background: #fff; }
  .student-table input:focus { outline: none; border-color: var(--primary-light); }
  .pct-badge { display: inline-block; padding: 2px 8px; border-radius: 20px; font-weight: 600; font-size: 0.8rem; }
  .pct-badge.pass { background: #d1fae5; color: #065f46; }
  .pct-badge.fail { background: #fee2e2; color: #991b1b; }

  .btn { padding: 9px 20px; border-radius: var(--radius-sm); border: none; cursor: pointer; font-family: 'Sarabun', sans-serif; font-size: 0.9rem; font-weight: 600; transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px; }
  .btn:disabled { opacity: 0.55; cursor: not-allowed; transform: none !important; }
  .btn-primary { background: var(--primary); color: #fff; box-shadow: 0 2px 8px rgba(26,86,168,0.25); }
  .btn-primary:hover:not(:disabled) { background: var(--primary-dark); transform: translateY(-1px); }
  .btn-accent { background: var(--accent); color: #fff; }
  .btn-accent:hover:not(:disabled) { background: #0284c7; transform: translateY(-1px); }
  .btn-danger { background: var(--danger); color: #fff; }
  .btn-danger:hover:not(:disabled) { background: #dc2626; }
  .btn-success { background: var(--success); color: #fff; }
  .btn-success:hover:not(:disabled) { background: #059669; }
  .btn-outline { background: transparent; color: var(--primary); border: 1.5px solid var(--primary); }
  .btn-outline:hover:not(:disabled) { background: var(--accent-light); }
  .btn-sm { padding: 5px 12px; font-size: 0.8rem; }
  .btn-group { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 14px; }

  .tab-content { display: none; } .tab-content.active { display: block; }
  .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 14px; margin-bottom: 20px; }
  .stat-card { background: var(--surface); border-radius: var(--radius); border: 1px solid var(--border); padding: 18px 16px; text-align: center; box-shadow: var(--shadow); }
  .stat-card .val { font-family: 'Prompt', sans-serif; font-size: 2rem; font-weight: 700; color: var(--primary); }
  .stat-card .lbl { font-size: 0.8rem; color: var(--text-muted); margin-top: 4px; }
  .stat-card.danger .val { color: var(--danger); }
  .stat-card.warn .val { color: var(--warning); }
  .stat-card.ok .val { color: var(--success); }
  .chart-wrap { position: relative; height: 320px; }

  .settings-section { margin-bottom: 24px; }
  .settings-section h3 { font-family: 'Prompt', sans-serif; font-size: 0.95rem; font-weight: 600; color: var(--primary-dark); margin-bottom: 12px; }
  .textarea-big { width: 100%; min-height: 100px; border: 1.5px solid var(--border); border-radius: var(--radius-sm); padding: 10px 12px; font-family: 'Sarabun', sans-serif; font-size: 0.9rem; resize: vertical; background: var(--surface2); }
  .textarea-big:focus { outline: none; border-color: var(--primary-light); }
  .tag-list { display: flex; flex-wrap: wrap; gap: 7px; margin-top: 8px; }
  .tag { background: var(--accent-light); color: var(--primary); padding: 4px 12px; border-radius: 20px; font-size: 0.82rem; font-weight: 500; display: flex; align-items: center; gap: 6px; }
  .tag .del { cursor: pointer; color: var(--danger); font-weight: 700; }

  .toast { position: fixed; bottom: 28px; right: 28px; z-index: 9999; background: var(--primary); color: #fff; padding: 12px 22px; border-radius: var(--radius-sm); box-shadow: var(--shadow-lg); font-size: 0.9rem; font-weight: 500; transform: translateY(80px); opacity: 0; transition: all 0.3s; max-width: 340px; }
  .toast.show { transform: translateY(0); opacity: 1; }
  .toast.success { background: var(--success); }
  .toast.error { background: var(--danger); }
  .toast.warn { background: var(--warning); color: #1e2d4a; }

  .empty-state { text-align: center; padding: 40px; color: var(--text-muted); }
  .empty-state .icon { font-size: 3rem; margin-bottom: 10px; }

  .record-card { background: var(--surface2); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 14px 16px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: space-between; }
  .record-card:hover { border-color: var(--primary-light); box-shadow: 0 2px 10px rgba(26,86,168,0.1); }
  .record-card.selected { border-color: var(--primary); background: var(--accent-light); }
  .record-info strong { color: var(--primary); font-size: 0.95rem; }
  .record-meta { font-size: 0.78rem; color: var(--text-muted); margin-top: 3px; }
  .flex-between { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px; }
  .section-bar { background: linear-gradient(135deg, var(--primary-dark), var(--primary)); color: #fff; border-radius: var(--radius-sm); padding: 10px 16px; margin-bottom: 14px; font-family: 'Prompt', sans-serif; font-weight: 600; font-size: 0.92rem; }
  hr.divider { border: none; border-top: 1px solid var(--border); margin: 20px 0; }

  /* LOADING OVERLAY */
  .loading-overlay { position: fixed; inset: 0; background: rgba(15,61,122,0.5); z-index: 500; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 16px; }
  .spinner { width: 52px; height: 52px; border: 5px solid rgba(255,255,255,0.3); border-top-color: #fff; border-radius: 50%; animation: spin 0.8s linear infinite; }
  .loading-msg { color: #fff; font-size: 1rem; font-weight: 500; font-family: 'Sarabun', sans-serif; }
  @keyframes spin { to { transform: rotate(360deg); } }

  .top5-table { width:100%; border-collapse:collapse; font-size:0.86rem; }
  .top5-table th { background: var(--primary); color:#fff; padding:8px 10px; text-align:left; font-weight:600; font-size:0.8rem; }
  .top5-table th:first-child { border-radius:6px 0 0 0; } .top5-table th:last-child { border-radius:0 6px 0 0; }
  .top5-table td { padding:8px 10px; border-bottom:1px solid var(--border); vertical-align:middle; }
  .top5-table tr:last-child td { border-bottom:none; }
  .top5-table tr:hover td { background:var(--accent-light); }
  .rank-badge { display:inline-flex;align-items:center;justify-content:center;width:24px;height:24px;border-radius:50%;font-weight:700;font-size:0.82rem;flex-shrink:0; }
  .rank-1 { background:#fbbf24;color:#78350f; }
  .rank-2 { background:#9ca3af;color:#1f2937; }
  .rank-3 { background:#d97706;color:#fff; }
  .rank-other { background:#e0f2fe;color:#1a56a8; }
  @media (max-width:700px) { #top5-grid { grid-template-columns:1fr !important; } }

  /* print student table */
  .ms-student-table { width:100%;border-collapse:collapse;font-size:0.85rem; margin-top:8px; }
  .ms-student-table th { background:var(--primary);color:#fff;padding:8px 10px;text-align:left;font-weight:600;font-size:0.8rem; }
  .ms-student-table td { padding:7px 10px;border-bottom:1px solid var(--border); }
  .ms-student-table tr:nth-child(even) td { background:var(--surface2); }
  .ms-student-table tr:hover td { background:var(--accent-light); }
  .freq-badge { display:inline-block;padding:2px 10px;border-radius:20px;font-weight:700;font-size:0.82rem; }
  .freq-high { background:#fee2e2;color:#991b1b; }
  .freq-mid  { background:#fef9c3;color:#854d0e; }
  .freq-low  { background:#d1fae5;color:#065f46; }

  @media (max-width: 600px) {
    .header { padding: 12px 16px; } .sync-indicator { display: none; }
    .main { padding: 16px 10px; } .nav { padding: 0 8px; }
    .nav-btn { padding: 12px 14px; font-size: 0.85rem; }
  }
</style>
</head>
<body>

<div class="loading-overlay" id="loading-overlay">
  <div class="spinner"></div>
  <div class="loading-msg" id="loading-msg">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets...</div>
</div>

<div class="header">
  <img src="https://nonthaphathr.github.io/uploadimg/logoschool.png" alt="Logo" onerror="this.style.display='none'">
  <div class="header-text">
    <h1>‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡∏£‡∏ß‡∏à‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞ 80</h1>
    <p>‡∏Ñ‡∏£‡∏π‡∏¢‡∏∏‡∏û‡∏≤ ‡∏ó‡∏≠‡∏á‡∏Ñ‡∏≥ | ‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏î‡∏ú‡∏•‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ú‡∏• ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£ ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡∏£‡∏∞‡∏î‡∏∏‡∏°‡∏ó‡∏≠‡∏á‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤</p>
  </div>
  <div class="sync-indicator" id="sync-indicator">
    <div class="sync-dot" id="sync-dot"></div>
    <span id="sync-label">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...</span>
  </div>
</div>

<nav class="nav">
  <button class="nav-btn active" onclick="switchTab('input')" id="tab-input">üìù ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
  <button class="nav-btn" onclick="switchTab('stats')" id="tab-stats">üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</button>
  <button class="nav-btn" onclick="switchTab('print')" id="tab-print">üñ®Ô∏è ‡∏™‡∏±‡πà‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå</button>
  <button class="nav-btn" onclick="switchTab('settings')" id="tab-settings">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
  <button class="nav-btn" onclick="exportExcel()" style="margin-left:auto;color:var(--success);font-weight:600;">üìä Export Excel</button>
</nav>

<div class="main">

  <!-- TAB 1 -->
  <div id="tab-content-input" class="tab-content active">
    <div class="card" id="form-card">
      <div class="card-title">‚úèÔ∏è <span id="form-title">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤</span></div>
      <div class="form-grid">
        <div class="form-group" style="grid-column: span 2;">
          <label>‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô *</label>
          <div style="display:grid;grid-template-columns:120px 1fr 1fr;gap:8px;">
            <select class="form-control" id="f-teacher-prefix">
              <option value="‡∏ô‡∏≤‡∏¢">‡∏ô‡∏≤‡∏¢</option>
              <option value="‡∏ô‡∏≤‡∏á">‡∏ô‡∏≤‡∏á</option>
              <option value="‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß">‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß</option>
            </select>
            <input type="text" class="form-control" id="f-teacher-fname" placeholder="‡∏ä‡∏∑‡πà‡∏≠">
            <input type="text" class="form-control" id="f-teacher-lname" placeholder="‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
          </div>
        </div>
        <div class="form-group"><label>‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ *</label><select class="form-control" id="f-subject-group"><option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞ --</option></select></div>
        <div class="form-group"><label>‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏¥‡∏ä‡∏≤ *</label><input type="text" class="form-control" id="f-code" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ó31101"></div>
        <div class="form-group"><label>‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤ *</label><input type="text" class="form-control" id="f-name" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ 1"></div>
        <div class="form-group"><label>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô *</label>
          <select class="form-control" id="f-level">
            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô --</option>
            <option value="‡∏°.1">‡∏°.1</option>
            <option value="‡∏°.2">‡∏°.2</option>
            <option value="‡∏°.3">‡∏°.3</option>
            <option value="‡∏°.4">‡∏°.4</option>
            <option value="‡∏°.5">‡∏°.5</option>
            <option value="‡∏°.6">‡∏°.6</option>
          </select>
        </div>
      </div>
      <div class="section-bar" style="margin-top:20px;">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div>
      <div style="display:flex;gap:8px;margin-bottom:10px;flex-wrap:wrap;align-items:center;">
        <button class="btn btn-outline btn-sm" onclick="addStudentRow()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ñ‡∏ß</button>
        <button class="btn btn-outline btn-sm" onclick="openPasteModal()">üìã ‡∏ß‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏≤‡∏¢‡πÅ‡∏ñ‡∏ß</button>
        <span style="font-size:0.78rem;color:var(--text-muted);">‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á 80%</span>
      </div>
      <div class="student-table-wrap">
        <table class="student-table">
          <thead><tr>
            <th style="width:36px">#</th>
            <th style="width:82px">‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤</th>
            <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
            <th style="width:72px">‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
            <th style="width:72px">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</th>
            <th style="width:64px">‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞</th>
            <th style="width:48px">‡∏•‡∏ö</th>
          </tr></thead>
          <tbody id="student-tbody"></tbody>
        </table>
      </div>
      <div class="btn-group">
        <button class="btn btn-primary" id="btn-save" onclick="saveRecord()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
        <button class="btn btn-outline" onclick="clearForm()">üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°</button>
        <button id="btn-update" class="btn btn-accent" onclick="updateRecord()" style="display:none;">‚úèÔ∏è ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
        <button id="btn-delete" class="btn btn-danger" onclick="deleteRecord()" style="display:none;">üóëÔ∏è ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ</button>
      </div>
    </div>

    <div class="card">
      <div class="flex-between card-title" style="margin-bottom:12px;">
        <span>üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß</span>
        <div style="display:flex;gap:8px;">
          <button class="btn btn-outline btn-sm" onclick="loadFromSheets()">üîÑ ‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å Sheets</button>
          <button class="btn btn-primary btn-sm" onclick="startNewRecord()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà</button>
        </div>
      </div>
      <!-- FILTER BAR -->
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:8px;margin-bottom:12px;padding:12px;background:var(--surface2);border-radius:var(--radius-sm);border:1px solid var(--border);">
        <input type="text" class="form-control" id="filter-code" placeholder="üîç ‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏¥‡∏ä‡∏≤" oninput="renderRecordList()" style="font-size:0.85rem;">
        <input type="text" class="form-control" id="filter-name" placeholder="üîç ‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤" oninput="renderRecordList()" style="font-size:0.85rem;">
        <select class="form-control" id="filter-group" onchange="renderRecordList()" style="font-size:0.85rem;">
          <option value="">üìö ‡∏ó‡∏∏‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞</option>
        </select>
        <input type="text" class="form-control" id="filter-teacher" placeholder="üîç ‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô" oninput="renderRecordList()" style="font-size:0.85rem;">
        <button class="btn btn-outline btn-sm" onclick="clearFilters()" style="white-space:nowrap;">‚úï ‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</button>
      </div>
      <div id="record-count" style="font-size:0.8rem;color:var(--text-muted);margin-bottom:8px;"></div>
      <div id="record-list"><div class="empty-state"><div class="icon">‚è≥</div><p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p></div></div>
    </div>
  </div>

  <!-- TAB 2 -->
  <div id="tab-content-stats" class="tab-content">
    <div class="stats-grid" id="stats-summary"></div>
    <!-- TOP 5 TABLES -->
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px;" id="top5-grid">
      <div class="card" style="margin-bottom:0;">
        <div class="card-title">üèÜ ‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡∏°‡∏™. ‡∏°‡∏≤‡∏Å‡∏™‡∏∏‡∏î 5 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</div>
        <div id="top5-subjects"></div>
      </div>
      <div class="card" style="margin-bottom:0;">
        <div class="card-title">üë§ ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î ‡∏°‡∏™. ‡∏°‡∏≤‡∏Å‡∏™‡∏∏‡∏î 5 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</div>
        <div id="top5-students"></div>
      </div>
    </div>
    <div class="card"><div class="card-title">üìä ‡∏Å‡∏£‡∏≤‡∏ü‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡∏°‡∏™. ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤</div><div class="chart-wrap"><canvas id="chart-subject"></canvas></div></div>
    <div class="card"><div class="card-title">üìä ‡∏Å‡∏£‡∏≤‡∏ü‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡∏°‡∏™. ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞</div><div class="chart-wrap"><canvas id="chart-group"></canvas></div></div>
    <div class="card"><div class="card-title">üìä ‡∏Å‡∏£‡∏≤‡∏ü‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡∏°‡∏™. ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô</div><div class="chart-wrap"><canvas id="chart-level"></canvas></div></div>
  </div>

  <!-- TAB 3 -->
  <div id="tab-content-print" class="tab-content">
    <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏ß‡∏° (‡∏ô‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà) -->
    <div class="card">
      <div class="flex-between" style="margin-bottom:12px;">
        <div class="card-title" style="margin-bottom:0">üìã ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î ‡∏°‡∏™. (‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤)</div>
        <div style="display:flex;gap:8px;align-items:center;">
          <input type="text" class="form-control" id="student-table-search" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠..." style="width:180px;font-size:0.85rem;" oninput="renderStudentFreqTable()">
        </div>
      </div>
      <div id="student-freq-table-wrap"></div>
    </div>
    <!-- ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤ -->
    <div class="card">
      <div class="flex-between" style="margin-bottom:16px;">
        <div class="card-title" style="margin-bottom:0">üñ®Ô∏è ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏°‡∏™.</div>
        <div style="display:flex;gap:8px;">
          <button class="btn btn-primary" onclick="printDoc()">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</button>
          <button class="btn btn-outline" onclick="generatePrintPreview()">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
        </div>
      </div>
      <div id="print-preview-area" style="border:1px solid var(--border);border-radius:var(--radius-sm);padding:20px;background:#fff;min-height:400px;"></div>
    </div>
  </div>

  <!-- TAB 4 -->
  <div id="tab-content-settings" class="tab-content">
    <div class="card">
      <div class="card-title">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</div>
      <div class="settings-section">
        <h3>üìÖ ‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤</h3>
        <input type="text" class="form-control" id="s-year" placeholder="‡πÄ‡∏ä‡πà‡∏ô 2568" style="max-width:200px;">
        <button class="btn btn-primary btn-sm" style="margin-top:8px;" onclick="saveYear()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
      </div>
      <hr class="divider">
      <div class="settings-section">
        <h3>üë• ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
        <p style="font-size:0.8rem;color:var(--text-muted);margin-bottom:4px;">‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡∏°‡∏™. ‚Äî ‡∏Ñ‡πà‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <strong>142 ‡∏Ñ‡∏ô</strong> (hardcode)</p>
      </div>
      <hr class="divider">
      <div class="settings-section">
        <h3>üìö ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</h3>
        <textarea class="textarea-big" id="s-groups-input" placeholder="‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢&#10;‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå&#10;‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ"></textarea>
        <button class="btn btn-primary btn-sm" style="margin-top:8px;" onclick="addGroups()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞</button>
        <div class="tag-list" id="group-tags"></div>
      </div>
      <hr class="divider">
      <div class="settings-section">
        <h3>üì§ Export ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
        <div style="display:flex;gap:10px;flex-wrap:wrap;">
          <button class="btn btn-success" onclick="exportExcel()">üìä Export Excel</button>
          <button class="btn btn-outline" onclick="exportJSON()">üìÑ Backup JSON</button>
          <button class="btn btn-outline" onclick="importJSON()">üì• ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ JSON</button>
          <input type="file" id="import-file" accept=".json" style="display:none" onchange="handleImport(this)">
        </div>
      </div>
      <hr class="divider">
      <div class="settings-section">
        <h3>üîß GAS Endpoint URL</h3>
        <p style="font-size:0.8rem;color:var(--text-muted);margin-bottom:8px;">‡∏´‡∏•‡∏±‡∏á Deploy GAS ‡πÉ‡∏´‡∏°‡πà ‡πÉ‡∏´‡πâ‡∏ß‡∏≤‡∏á URL ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</p>
        <input type="text" class="form-control" id="s-gas-url" style="font-size:0.78rem;font-family:monospace;" placeholder="https://script.google.com/macros/s/...">
        <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;">
          <button class="btn btn-primary btn-sm" onclick="saveGasUrl()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å URL</button>
          <button class="btn btn-outline btn-sm" onclick="testConnection()">üîå ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</button>
        </div>
        <div id="connection-status" style="margin-top:8px;font-size:0.82rem;"></div>
      </div>
    </div>
  </div>

</div>

<div class="toast" id="toast"></div>

<!-- PASTE MODAL -->
<div id="paste-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.45);z-index:200;align-items:center;justify-content:center;">
  <div style="background:#fff;border-radius:var(--radius);padding:28px;max-width:560px;width:90%;box-shadow:var(--shadow-lg);">
    <div style="font-family:'Prompt',sans-serif;font-weight:600;color:var(--primary);margin-bottom:10px;font-size:1rem;">üìã ‡∏ß‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏ô</div>
    <p style="font-size:0.82rem;color:var(--text-muted);margin-bottom:10px;">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: <strong>‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤ [Tab] ‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏• [Tab] ‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô [Tab] ‡∏£‡∏ß‡∏°</strong> ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏Ñ‡∏ô = 1 ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î<br>üìå Copy ‡∏à‡∏≤‡∏Å Excel ‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á</p>
    <textarea class="textarea-big" id="paste-input" style="min-height:160px;" placeholder="‡πÄ‡∏î‡πá‡∏Å‡∏ä‡∏≤‡∏¢	‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ	40	50&#10;‡πÄ‡∏î‡πá‡∏Å‡∏´‡∏ç‡∏¥‡∏á	‡∏™‡∏°‡πÉ‡∏à ‡∏£‡∏±‡∏Å‡∏î‡∏µ	45	50"></textarea>
    <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end;">
      <button class="btn btn-outline" onclick="closePasteModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      <button class="btn btn-primary" onclick="processPaste()">‚úÖ ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</button>
    </div>
  </div>
</div>

<!-- SETTINGS PIN MODAL -->
<div id="settings-pin-modal" style="display:none;position:fixed;inset:0;background:rgba(15,61,122,0.55);z-index:9000;align-items:center;justify-content:center;">
  <div style="background:#fff;border-radius:var(--radius);padding:40px 36px;max-width:340px;width:90%;box-shadow:var(--shadow-lg);text-align:center;">
    <div style="font-size:2.8rem;margin-bottom:10px;">üîí</div>
    <div style="font-family:'Prompt',sans-serif;font-weight:700;color:var(--primary);font-size:1.15rem;margin-bottom:6px;">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</div>
    <div style="font-size:0.85rem;color:var(--text-muted);margin-bottom:22px;">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô 4 ‡∏´‡∏•‡∏±‡∏Å</div>
    <input type="password" id="settings-pin-input" maxlength="4" inputmode="numeric" pattern="[0-9]*"
      style="width:150px;font-size:2rem;letter-spacing:14px;text-align:center;padding:10px 8px;border:2px solid var(--border);border-radius:var(--radius-sm);font-family:'Prompt',sans-serif;display:block;margin:0 auto 8px;"
      placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" oninput="checkSettingsPin()" onkeydown="if(event.key==='Enter')checkSettingsPin()">
    <div id="settings-pin-error" style="color:var(--danger);font-size:0.83rem;min-height:20px;margin-bottom:16px;"></div>
    <button class="btn btn-outline btn-sm" onclick="closeSettingsModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
  </div>
</div>

<script>
// ============================================================
// CONFIG & STATE
// ============================================================
const DEFAULT_GAS_URL = 'https://script.google.com/macros/s/AKfycbwmkbtM1tJa2-UCuXLbAyGO-d1nZ7Kf6MZAZuECIsSwlh8kuXWlzyD5htAXnrTwH0YD/exec';

let state = {
  records: [],     // loaded from Sheets
  teachers: [],    // from localStorage
  groups: [],      // from localStorage
  year: '2568',
  gasUrl: DEFAULT_GAS_URL,
  editingId: null
};
let chartSubject = null, chartGroup = null, chartLevel = null;
let rowId = 0;

// ============================================================
// INIT
// ============================================================
const TOTAL_STUDENTS = 142; // hardcode ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô

function init() {
  // ‡πÇ‡∏´‡∏•‡∏î gasUrl ‡∏à‡∏≤‡∏Å localStorage
  const savedUrl = localStorage.getItem('ms-gas-url');
  if (savedUrl) state.gasUrl = savedUrl;
  document.getElementById('s-gas-url').value = state.gasUrl;

  // ‡πÇ‡∏´‡∏•‡∏î settings ‡∏à‡∏≤‡∏Å cache localStorage
  const localSettings = localStorage.getItem('ms-settings');
  if (localSettings) {
    try {
      const s = JSON.parse(localSettings);
      state.groups = s.groups || [];
      state.year   = s.year   || '2568';
    } catch(e) {}
  }
  if (!state.groups.length) {
    state.groups = ['‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢','‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå','‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ','‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ‡∏®‡∏≤‡∏™‡∏ô‡∏≤ ‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏í‡∏ô‡∏ò‡∏£‡∏£‡∏°','‡∏™‡∏∏‡∏Ç‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÅ‡∏•‡∏∞‡∏û‡∏•‡∏®‡∏∂‡∏Å‡∏©‡∏≤','‡∏®‡∏¥‡∏•‡∏õ‡∏∞','‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏≠‡∏≤‡∏ä‡∏µ‡∏û','‡∏†‡∏≤‡∏©‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®'];
  }

  state.totalStudents = TOTAL_STUDENTS;
  document.getElementById('s-year').value = state.year;

  renderGroupDropdowns();
  renderGroupTags();
  initStudentRows(3);

  // ‡πÇ‡∏´‡∏•‡∏î settings + records ‡∏à‡∏≤‡∏Å Sheets
  loadAllFromSheets();
}

async function loadAllFromSheets() {
  showLoading('‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets...');
  setSyncState('loading', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...');
  try {
    const [settingsRes, recordsRes] = await Promise.all([
      gasGet({ action: 'getSettings' }),
      gasGet({ action: 'getAll' })
    ]);

    // ‚úÖ ‡πÇ‡∏´‡∏•‡∏î settings (groups, year)
    if (settingsRes.ok && settingsRes.settings) {
      const s = settingsRes.settings;
      if (Array.isArray(s.groups) && s.groups.length) state.groups = s.groups;
      if (s.year) state.year = s.year;
      document.getElementById('s-year').value = state.year;
      saveSettingsLocal();
      renderGroupDropdowns();
      renderGroupTags();
    }

    // ‚úÖ ‡πÇ‡∏´‡∏•‡∏î records
    if (recordsRes.ok) {
      state.records = recordsRes.records || [];
      localStorage.setItem('ms-records-cache', JSON.stringify(state.records));
      renderRecordList();
      setSyncState('ok', `‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß (${state.records.length} ‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤)`);
      showToast(`‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚Äî ${state.records.length} ‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤`, 'success');
    } else {
      throw new Error(recordsRes.error || 'GAS returned error');
    }
  } catch(err) {
    setSyncState('error', '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ');
    showToast('‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å Sheets ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message, 'error');
    const cache = localStorage.getItem('ms-records-cache');
    if (cache) {
      state.records = JSON.parse(cache);
      renderRecordList();
      showToast('‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• cache ‡πÅ‡∏ó‡∏ô (‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)', 'warn');
    } else {
      renderRecordList();
    }
  } finally {
    hideLoading();
  }
}


// ============================================================
// GAS API ‚Äî ‡πÉ‡∏ä‡πâ JSONP (GET) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á CORS
// ============================================================
function gasUrl() { return state.gasUrl || DEFAULT_GAS_URL; }

// JSONP: inject <script> tag ‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏≠ callback
function gasJsonp(params = {}) {
  return new Promise((resolve, reject) => {
    const cbName = 'gasCallback_' + Date.now() + '_' + Math.floor(Math.random()*9999);
    const timeout = setTimeout(() => {
      delete window[cbName];
      script.remove();
      reject(new Error('Timeout: GAS ‡πÑ‡∏°‡πà‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á‡πÉ‡∏ô 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ'));
    }, 30000);

    window[cbName] = (data) => {
      clearTimeout(timeout);
      delete window[cbName];
      script.remove();
      resolve(data);
    };

    const url = new URL(gasUrl());
    url.searchParams.set('callback', cbName);
    Object.entries(params).forEach(([k, v]) => url.searchParams.set(k, v));

    const script = document.createElement('script');
    script.src = url.toString();
    script.onerror = () => {
      clearTimeout(timeout);
      delete window[cbName];
      reject(new Error('‡πÇ‡∏´‡∏•‡∏î GAS script ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ‚Äî ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö URL ‡∏´‡∏£‡∏∑‡∏≠ Deploy ‡πÉ‡∏´‡∏°‡πà'));
    };
    document.head.appendChild(script);
  });
}

// GET ‡∏ò‡∏£‡∏£‡∏°‡∏î‡∏≤ (‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö getAll, ping)
async function gasGet(params = {}) {
  return gasJsonp(params);
}

// POST ‚Üí ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô GET + encode payload
async function gasPost(body) {
  const params = { action: body.action };
  if (body.record)    params.record    = encodeURIComponent(JSON.stringify(body.record));
  if (body.recordId)  params.recordId  = encodeURIComponent(String(body.recordId));
  if (body.settings)  params.settings  = encodeURIComponent(body.settings);
  return gasJsonp(params);
}

function saveSettingsLocal() {
  localStorage.setItem('ms-settings', JSON.stringify({
    groups: state.groups, year: state.year
  }));
  localStorage.setItem('ms-gas-url', state.gasUrl);
}

// ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å settings ‡∏Ç‡∏∂‡πâ‡∏ô Sheets
async function saveSettingsToSheets() {
  try {
    const settings = { groups: state.groups, year: state.year };
    const res = await gasPost({ action: 'saveSettings', settings: JSON.stringify(settings) });
    if (!res.ok) throw new Error(res.error);
  } catch(err) {
    console.warn('saveSettingsToSheets failed:', err.message);
  }
}

// ============================================================
// LOAD FROM SHEETS (manual refresh)
// ============================================================
async function loadFromSheets() {
  setSyncState('loading', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...');
  showLoading('‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets...');
  try {
    const data = await gasGet({ action: 'getAll' });
    if (data.ok) {
      state.records = data.records || [];
      localStorage.setItem('ms-records-cache', JSON.stringify(state.records));
      renderRecordList();
      setSyncState('ok', `‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß (${state.records.length} ‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤)`);
      showToast(`‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚Äî ${state.records.length} ‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤`, 'success');
    } else {
      throw new Error(data.error || 'GAS returned error');
    }
  } catch(err) {
    setSyncState('error', '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ');
    showToast('‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å Sheets ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + err.message, 'error');
    const cache = localStorage.getItem('ms-records-cache');
    if (cache) {
      state.records = JSON.parse(cache);
      renderRecordList();
      showToast('‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• cache ‡πÅ‡∏ó‡∏ô (‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)', 'warn');
    } else {
      renderRecordList();
    }
  } finally {
    hideLoading();
  }
}

// ============================================================
// SAVE (CREATE)
// ============================================================
async function saveRecord() {
  const data = getFormData();
  if (!validateForm(data)) return;

  const record = { id: 'rec_' + Date.now() + '_' + Math.random().toString(36).slice(2,6), year: state.year, ...data };
  setFormBusy(true);
  setSyncState('loading', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...');

  try {
    const res = await gasPost({ action: 'saveRecord', record });
    if (!res.ok) throw new Error(res.error || 'Save failed');
    state.records.push(record);
    localStorage.setItem('ms-records-cache', JSON.stringify(state.records));
    renderRecordList();
    clearForm();
    startNewRecord();
    setSyncState('ok', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß');
    Swal.fire({
      icon: 'success',
      title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üéâ',
      html: `<b>${record.code} ${record.name}</b><br>‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡∏°‡∏™. ${record.students.length} ‡∏Ñ‡∏ô<br><span style="font-size:0.85rem;color:#5a7099;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Google Sheets ‡πÅ‡∏•‡πâ‡∏ß</span>`,
      confirmButtonColor: '#1a56a8',
      confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
      timer: 3000,
      timerProgressBar: true
    });
    setTimeout(() => loadFromSheets(), 1500);
  } catch(err) {
    setSyncState('error', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
    Swal.fire({ icon: 'error', title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', text: err.message, confirmButtonColor: '#ef4444' });
  } finally {
    setFormBusy(false);
  }
}

// ============================================================
// UPDATE (EDIT)
// ============================================================
async function updateRecord() {
  const data = getFormData();
  if (!validateForm(data)) return;

  const record = { id: state.editingId, year: state.year, ...data };
  setFormBusy(true);
  setSyncState('loading', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï...');

  try {
    const res = await gasPost({ action: 'updateRecord', record });
    if (!res.ok) throw new Error(res.error || 'Update failed');
    const idx = state.records.findIndex(r => r.id === state.editingId);
    if (idx !== -1) state.records[idx] = record;
    localStorage.setItem('ms-records-cache', JSON.stringify(state.records));
    renderRecordList();
    clearForm();
    startNewRecord();
    setSyncState('ok', '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡πâ‡∏ß');
    Swal.fire({
      icon: 'success',
      title: '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‚úÖ',
      html: `<b>${record.code} ${record.name}</b><br><span style="font-size:0.85rem;color:#5a7099;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Google Sheets ‡πÅ‡∏•‡πâ‡∏ß</span>`,
      confirmButtonColor: '#1a56a8',
      confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á',
      timer: 3000,
      timerProgressBar: true
    });
    setTimeout(() => loadFromSheets(), 1500);
  } catch(err) {
    setSyncState('error', '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
    Swal.fire({ icon: 'error', title: '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', text: err.message, confirmButtonColor: '#ef4444' });
  } finally {
    setFormBusy(false);
  }
}

// ============================================================
// DELETE
// ============================================================
async function deleteRecord() {
  const result = await Swal.fire({
    icon: 'warning',
    title: '‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?',
    text: '‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ!',
    showCancelButton: true,
    confirmButtonColor: '#ef4444',
    cancelButtonColor: '#6b7280',
    confirmButtonText: '‡∏•‡∏ö‡πÄ‡∏•‡∏¢',
    cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
  });
  if (!result.isConfirmed) return;

  const recordId = state.editingId;
  setFormBusy(true);
  setSyncState('loading', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö...');

  try {
    const res = await gasPost({ action: 'deleteRecord', recordId });
    if (!res.ok) throw new Error(res.error || 'Delete failed');
    state.records = state.records.filter(r => r.id !== recordId);
    localStorage.setItem('ms-records-cache', JSON.stringify(state.records));
    renderRecordList();
    clearForm();
    startNewRecord();
    setSyncState('ok', '‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß');
    Swal.fire({ icon: 'success', title: '‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', text: '‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å Google Sheets ‡πÅ‡∏•‡πâ‡∏ß', confirmButtonColor: '#1a56a8', timer: 2500, timerProgressBar: true });
  } catch(err) {
    setSyncState('error', '‡∏•‡∏ö‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
    Swal.fire({ icon: 'error', title: '‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', text: err.message, confirmButtonColor: '#ef4444' });
  } finally {
    setFormBusy(false);
  }
}

// ============================================================
// TEST CONNECTION
// ============================================================
async function testConnection() {
  const el = document.getElementById('connection-status');
  el.innerHTML = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö...';
  try {
    const res = await gasGet({ action: 'ping' });
    if (res.ok) {
      el.innerHTML = `<span style="color:var(--success)">‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå: ${res.time}</span>`;
      showToast('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ GAS ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
    } else throw new Error(res.error);
  } catch(err) {
    el.innerHTML = `<span style="color:var(--danger)">‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ: ${err.message}</span>`;
    showToast('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß', 'error');
  }
}

// ============================================================
// FORM
// ============================================================
function getFormData() {
  const rows = document.querySelectorAll('#student-tbody tr');
  const students = [];
  rows.forEach(r => {
    const id = r.id.replace('row-', '');
    const prefix   = document.getElementById('pre-' + id)?.value || '';
    const fullname = (document.getElementById('name-' + id)?.value || '').trim();
    const attended = parseFloat(document.getElementById('att-' + id)?.value) || 0;
    const total    = parseFloat(document.getElementById('tot-' + id)?.value) || 0;
    if (fullname) students.push({ prefix, fullname, attended, total });
  });
  const tPrefix = document.getElementById('f-teacher-prefix').value;
  const tFname  = document.getElementById('f-teacher-fname').value.trim();
  const tLname  = document.getElementById('f-teacher-lname').value.trim();
  const teacher = tFname ? `${tPrefix}${tFname} ${tLname}`.trim() : '';
  return {
    teacher,
    group:   document.getElementById('f-subject-group').value,
    code:    document.getElementById('f-code').value.trim(),
    name:    document.getElementById('f-name').value.trim(),
    level:   document.getElementById('f-level').value,
    students
  };
}

function validateForm(data) {
  if (!data.teacher)  { Swal.fire({ icon:'warning', title:'‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô', confirmButtonColor:'#1a56a8' }); return false; }
  if (!data.group)    { Swal.fire({ icon:'warning', title:'‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞', confirmButtonColor:'#1a56a8' }); return false; }
  if (!data.code)     { Swal.fire({ icon:'warning', title:'‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏¥‡∏ä‡∏≤', confirmButtonColor:'#1a56a8' }); return false; }
  if (!data.name)     { Swal.fire({ icon:'warning', title:'‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤', confirmButtonColor:'#1a56a8' }); return false; }
  if (!data.level)    { Swal.fire({ icon:'warning', title:'‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô', confirmButtonColor:'#1a56a8' }); return false; }
  if (!data.students.length) { Swal.fire({ icon:'warning', title:'‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏Ñ‡∏ô', confirmButtonColor:'#1a56a8' }); return false; }
  return true;
}

function setFormBusy(busy) {
  ['btn-save','btn-update','btn-delete'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.disabled = busy;
  });
}

function startNewRecord() {
  state.editingId = null;
  document.getElementById('form-title').textContent = '‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡πÉ‡∏´‡∏°‡πà';
  document.getElementById('btn-save').style.display   = '';
  document.getElementById('btn-update').style.display = 'none';
  document.getElementById('btn-delete').style.display = 'none';
  document.querySelectorAll('.record-card').forEach(c => c.classList.remove('selected'));
}

function clearForm() {
  document.getElementById('f-teacher-prefix').value = '‡∏ô‡∏≤‡∏¢';
  document.getElementById('f-teacher-fname').value  = '';
  document.getElementById('f-teacher-lname').value  = '';
  ['f-subject-group','f-code','f-name','f-level'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = '';
  });
  document.getElementById('student-tbody').innerHTML = '';
  rowId = 0;
  initStudentRows(3);
}

// ============================================================
// RECORD LIST + FILTER
// ============================================================
function populateFilterGroup() {
  const sel = document.getElementById('filter-group');
  if (!sel) return;
  const current = sel.value;
  const groups = [...new Set(state.records.map(r => r.group).filter(Boolean))].sort();
  sel.innerHTML = '<option value="">üìö ‡∏ó‡∏∏‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞</option>';
  groups.forEach(g => sel.innerHTML += `<option value="${g}">${g}</option>`);
  if (current) sel.value = current;
}

function clearFilters() {
  ['filter-code','filter-name','filter-teacher'].forEach(id => {
    const el = document.getElementById(id); if (el) el.value = '';
  });
  const fg = document.getElementById('filter-group'); if (fg) fg.value = '';
  renderRecordList();
}

function renderRecordList() {
  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï dropdown ‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡πÉ‡∏ô filter
  populateFilterGroup();

  const fCode    = (document.getElementById('filter-code')?.value    || '').trim().toLowerCase();
  const fName    = (document.getElementById('filter-name')?.value    || '').trim().toLowerCase();
  const fGroup   = (document.getElementById('filter-group')?.value   || '');
  const fTeacher = (document.getElementById('filter-teacher')?.value || '').trim().toLowerCase();

  const filtered = state.records.filter(r => {
    if (fCode    && !(r.code  || '').toLowerCase().includes(fCode))    return false;
    if (fName    && !((r.name || r.subjectName || '')).toLowerCase().includes(fName)) return false;
    if (fGroup   && r.group !== fGroup)  return false;
    if (fTeacher && !(r.teacher || '').toLowerCase().includes(fTeacher)) return false;
    return true;
  });

  const countEl = document.getElementById('record-count');
  if (countEl) {
    const hasFilter = fCode || fName || fGroup || fTeacher;
    countEl.textContent = hasFilter
      ? `‡πÅ‡∏™‡∏î‡∏á ${filtered.length} ‡∏à‡∏≤‡∏Å ${state.records.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`
      : `‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${state.records.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
  }

  const wrap = document.getElementById('record-list');
  if (!state.records.length) {
    wrap.innerHTML = '<div class="empty-state"><div class="icon">üìÇ</div><p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏Å‡∏î "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</p></div>';
    return;
  }
  if (!filtered.length) {
    wrap.innerHTML = '<div class="empty-state"><div class="icon">üîç</div><p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</p></div>';
    return;
  }
  wrap.innerHTML = filtered.map(r => {
    const msCount = r.students.length;
    return `<div class="record-card" data-id="${r.id}" onclick="editRecord('${r.id}')">
      <div class="record-info">
        <strong>${r.code} ${r.name || r.subjectName || ''}</strong>
        <div class="record-meta">üè´ ${r.level} | üë®‚Äçüè´ ${r.teacher} | üìö ${r.group}</div>
      </div>
      <span style="background:#fee2e2;color:#991b1b;padding:3px 10px;border-radius:20px;font-size:0.8rem;font-weight:600;white-space:nowrap;">‡∏°‡∏™. ${msCount} ‡∏Ñ‡∏ô</span>
    </div>`;
  }).join('');
}

function editRecord(id) {
  const rec = state.records.find(r => r.id === id);
  if (!rec) return;
  state.editingId = id;

  // ‡πÅ‡∏¢‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏£‡∏π‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤ ‡∏ä‡∏∑‡πà‡∏≠ ‡∏™‡∏Å‡∏∏‡∏•
  const teacherFull = rec.teacher || '';
  const prefixes = ['‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß','‡∏ô‡∏≤‡∏á','‡∏ô‡∏≤‡∏¢'];
  let tPrefix = '‡∏ô‡∏≤‡∏¢', tRest = teacherFull;
  for (const p of prefixes) {
    if (teacherFull.startsWith(p)) { tPrefix = p; tRest = teacherFull.slice(p.length).trim(); break; }
  }
  const parts = tRest.split(' ');
  document.getElementById('f-teacher-prefix').value = tPrefix;
  document.getElementById('f-teacher-fname').value  = parts[0] || '';
  document.getElementById('f-teacher-lname').value  = parts.slice(1).join(' ') || '';

  document.getElementById('f-subject-group').value = rec.group        || '';
  document.getElementById('f-code').value          = rec.code         || '';
  document.getElementById('f-name').value          = rec.name || rec.subjectName || '';
  document.getElementById('f-level').value         = rec.level        || '';

  const _subLabel = rec.name || rec.subjectName || '';
  document.getElementById('form-title').textContent = `‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ${rec.code} ${_subLabel}`;
  document.getElementById('btn-save').style.display   = 'none';
  document.getElementById('btn-update').style.display = '';
  document.getElementById('btn-delete').style.display = '';
  document.getElementById('student-tbody').innerHTML = '';
  rowId = 0;
  rec.students.forEach(s => addStudentRow(s.prefix, s.fullname, s.attended, s.total));
  document.getElementById('form-card').scrollIntoView({ behavior: 'smooth' });
  document.querySelectorAll('.record-card').forEach(c => c.classList.remove('selected'));
  document.querySelector(`.record-card[data-id="${id}"]`)?.classList.add('selected');
}

// ============================================================
// STUDENT ROWS
// ============================================================
function initStudentRows(n = 3) { for (let i = 0; i < n; i++) addStudentRow(); }

function addStudentRow(prefix = '', fullname = '', attended = '', total = '') {
  const tbody = document.getElementById('student-tbody');
  const id = rowId++;
  const tr = document.createElement('tr');
  tr.id = 'row-' + id;
  tr.innerHTML = `
    <td style="color:var(--text-muted);font-size:0.8rem;text-align:center;">${tbody.rows.length + 1}</td>
    <td><select id="pre-${id}" style="min-width:76px;border:1px solid var(--border);border-radius:5px;padding:5px 4px;font-family:'Sarabun',sans-serif;font-size:0.87rem;background:#fff;">
      <option value="‡πÄ‡∏î‡πá‡∏Å‡∏ä‡∏≤‡∏¢" ${prefix==='‡πÄ‡∏î‡πá‡∏Å‡∏ä‡∏≤‡∏¢'?'selected':''}>‡πÄ‡∏î‡πá‡∏Å‡∏ä‡∏≤‡∏¢</option>
      <option value="‡πÄ‡∏î‡πá‡∏Å‡∏´‡∏ç‡∏¥‡∏á" ${prefix==='‡πÄ‡∏î‡πá‡∏Å‡∏´‡∏ç‡∏¥‡∏á'?'selected':''}>‡πÄ‡∏î‡πá‡∏Å‡∏´‡∏ç‡∏¥‡∏á</option>
      <option value="‡∏ô‡∏≤‡∏¢" ${prefix==='‡∏ô‡∏≤‡∏¢'?'selected':''}>‡∏ô‡∏≤‡∏¢</option>
      <option value="‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß" ${prefix==='‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß'?'selected':''}>‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß</option>
    </select></td>
    <td><input type="text" id="name-${id}" value="${fullname}" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•"></td>
    <td><input type="number" id="att-${id}" value="${attended}" placeholder="0" min="0" style="text-align:center;" oninput="calcPct(${id})"></td>
    <td><input type="number" id="tot-${id}" value="${total}" placeholder="0" min="0" style="text-align:center;" oninput="calcPct(${id})"></td>
    <td style="text-align:center;"><span id="pct-${id}" class="pct-badge">-</span></td>
    <td><button class="btn btn-danger btn-sm" onclick="removeRow(${id})">‚úï</button></td>`;
  tbody.appendChild(tr);
  renumberRows();
  if (attended && total) calcPct(id);
}

function calcPct(id) {
  const att = parseFloat(document.getElementById('att-'+id)?.value) || 0;
  const tot = parseFloat(document.getElementById('tot-'+id)?.value) || 0;
  const badge = document.getElementById('pct-'+id);
  if (!badge) return;
  if (tot === 0) { badge.textContent = '-'; badge.className = 'pct-badge'; return; }
  const pct = att/tot*100;
  badge.textContent = pct.toFixed(1) + '%';
  badge.className = pct >= 80 ? 'pct-badge pass' : 'pct-badge fail';
  const row = document.getElementById('row-'+id);
  if (row) row.className = pct < 80 ? 'ms-row' : '';
}

function removeRow(id) { document.getElementById('row-'+id)?.remove(); renumberRows(); }

function renumberRows() {
  document.querySelectorAll('#student-tbody tr').forEach((r, i) => { if (r.cells[0]) r.cells[0].textContent = i + 1; });
}

// ============================================================
// PASTE MODAL
// ============================================================
function openPasteModal() {
  document.getElementById('paste-modal').style.display = 'flex';
  document.getElementById('paste-input').value = '';
  setTimeout(() => document.getElementById('paste-input').focus(), 80);
}
function closePasteModal() { document.getElementById('paste-modal').style.display = 'none'; }
function processPaste() {
  const raw = document.getElementById('paste-input').value.trim();
  closePasteModal();
  if (!raw) return;
  let count = 0;
  raw.split('\n').forEach(line => {
    if (!line.trim()) return;
    const parts = line.split(/\t|\|/).map(s => s.trim());
    if (parts.length >= 2) addStudentRow(parts[0], parts[1]);
    else                    addStudentRow('', parts[0]);
    count++;
  });
  showToast(`‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ ${count} ‡πÅ‡∏ñ‡∏ß‡πÅ‡∏•‡πâ‡∏ß ‚úÖ`, 'success');
}

// ============================================================
// DROPDOWNS & SETTINGS
// ============================================================
function renderTeacherDropdowns() { /* ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ ‚Äî ‡∏Ñ‡∏£‡∏π‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏≠‡∏á */ }
function renderTeacherTags() { /* ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ */ }
function saveTotalStudents() { /* hardcode 142 */ }
function updateTotalStudentsDisplay() { /* hardcode 142 */ }
function renderGroupDropdowns() {
  const sel = document.getElementById('f-subject-group'), val = sel.value;
  sel.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞ --</option>';
  state.groups.forEach(g => sel.innerHTML += `<option value="${g}">${g}</option>`);
  if (val) sel.value = val;
}
function renderGroupTags() {
  document.getElementById('group-tags').innerHTML = state.groups.map((g,i) =>
    `<div class="tag">${g} <span class="del" onclick="removeGroup(${i})">‚úï</span></div>`).join('');
}
function saveYear() {
  state.year = document.getElementById('s-year').value.trim() || '2568';
  saveSettingsLocal();
  saveSettingsToSheets();
  showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡πÅ‡∏•‡πâ‡∏ß ‚úÖ', 'success');
}
function saveGasUrl() {
  state.gasUrl = document.getElementById('s-gas-url').value.trim() || DEFAULT_GAS_URL;
  saveSettingsLocal();
  showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å URL ‡πÅ‡∏•‡πâ‡∏ß', 'success');
}
function addGroups() {
  const raw = document.getElementById('s-groups-input').value.trim(); if (!raw) return;
  raw.split('\n').forEach(g => { g = g.trim(); if (g && !state.groups.includes(g)) state.groups.push(g); });
  document.getElementById('s-groups-input').value = '';
  saveSettingsLocal(); saveSettingsToSheets();
  renderGroupTags(); renderGroupDropdowns();
  showToast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞‡πÅ‡∏•‡πâ‡∏ß ‚úÖ (sync ‡∏Ç‡∏∂‡πâ‡∏ô Sheets)', 'success');
}
function removeGroup(i) {
  state.groups.splice(i,1);
  saveSettingsLocal(); saveSettingsToSheets();
  renderGroupTags(); renderGroupDropdowns();
}

// ============================================================
// TAB NAVIGATION
// ============================================================
function switchTab(tab) {
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('tab-content-' + tab).classList.add('active');
  document.getElementById('tab-' + tab).classList.add('active');
  if (tab === 'stats') renderStats();
  if (tab === 'print') { renderStudentFreqTable(); generatePrintPreview(); }
  if (tab === 'settings') showSettingsLock();
  else settingsUnlocked = false;
}

// ‚îÄ‚îÄ SETTINGS PASSWORD LOCK ‚îÄ‚îÄ
const SETTINGS_PIN = '1111';
let settingsUnlocked = false;

function showSettingsLock() {
  if (settingsUnlocked) return;
  const modal = document.getElementById('settings-pin-modal');
  modal.style.display = 'flex';
  document.getElementById('settings-pin-input').value = '';
  document.getElementById('settings-pin-error').textContent = '';
  setTimeout(() => document.getElementById('settings-pin-input').focus(), 80);
}

function closeSettingsModal() {
  document.getElementById('settings-pin-modal').style.display = 'none';
  // Go back to input tab if cancelled
  switchTabSilent('input');
}

function switchTabSilent(tab) {
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('tab-content-' + tab).classList.add('active');
  document.getElementById('tab-' + tab).classList.add('active');
}

function checkSettingsPin() {
  const input = document.getElementById('settings-pin-input').value;
  if (input.length < 4) return;
  if (input === SETTINGS_PIN) {
    settingsUnlocked = true;
    document.getElementById('settings-pin-modal').style.display = 'none';
    showToast('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡πâ‡∏ß üîì', 'success');
  } else {
    document.getElementById('settings-pin-error').textContent = '‚ùå ‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
    document.getElementById('settings-pin-input').value = '';
    setTimeout(() => document.getElementById('settings-pin-error').textContent = '', 2000);
  }
}

// Reset lock when leaving settings tab (handled in switchTab)

// ============================================================
// STATS
// ============================================================
function getMSStudents() {
  // ‡∏Ñ‡∏£‡∏π‡∏™‡πà‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡∏°‡∏™. ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ = ‡∏°‡∏™.
  const all = [];
  state.records.forEach(r => r.students.forEach(s => {
    all.push({ ...s, code: r.code, subjectName: r.name || r.subjectName || '', group: r.group, level: r.level });
  }));
  return all;
}

function renderStats() {
  const ms = getMSStudents();
  const schoolTotal = TOTAL_STUDENTS;
  const msCount = ms.length;
  const pctMs = (msCount / schoolTotal * 100).toFixed(1);
  document.getElementById('stats-summary').innerHTML = `
    <div class="stat-card"><div class="val">${state.records.length}</div><div class="lbl">‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div></div>
    <div class="stat-card"><div class="val">${schoolTotal || '-'}</div><div class="lbl">‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div></div>
    <div class="stat-card danger"><div class="val">${msCount}</div><div class="lbl">‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î ‡∏°‡∏™.</div></div>
    <div class="stat-card warn"><div class="val">${pctMs}%</div><div class="lbl">‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞ ‡∏°‡∏™. (‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô)</div></div>
    <div class="stat-card ok"><div class="val">${schoolTotal ? schoolTotal - msCount : '-'}</div><div class="lbl">‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î ‡∏°‡∏™.</div></div>`;

  const subjectMap = {}, groupMap = {}, levelMap = {};
  ms.forEach(s => {
    const k = s.code + ' ' + s.subjectName;
    subjectMap[k] = (subjectMap[k]||0) + 1;
    groupMap[s.group] = (groupMap[s.group]||0) + 1;
    levelMap[s.level] = (levelMap[s.level]||0) + 1;
  });
  if (chartSubject) chartSubject.destroy();
  if (chartGroup)   chartGroup.destroy();
  if (chartLevel)   chartLevel.destroy();
  chartSubject = buildChart('chart-subject', subjectMap);
  chartGroup   = buildChart('chart-group',   groupMap);
  chartLevel   = buildChart('chart-level',   levelMap);

  renderTop5(ms, subjectMap);
}

// ============================================================
// TOP 5
// ============================================================
function renderTop5(ms, subjectMap) {
  // Top 5 ‡∏ß‡∏¥‡∏ä‡∏≤
  const top5sub = Object.entries(subjectMap)
    .sort((a,b) => b[1]-a[1]).slice(0,5);
  const subEl = document.getElementById('top5-subjects');
  if (!top5sub.length) { subEl.innerHTML = '<div class="empty-state" style="padding:20px"><p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p></div>'; }
  else {
    subEl.innerHTML = `<table class="top5-table">
      <thead><tr><th style="width:36px">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</th><th>‡∏£‡∏´‡∏±‡∏™ / ‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤</th><th style="width:70px;text-align:center">‡∏°‡∏™.</th></tr></thead>
      <tbody>${top5sub.map(([subj, cnt], i) => {
        const rank = i+1;
        const rc = rank===1?'rank-1':rank===2?'rank-2':rank===3?'rank-3':'rank-other';
        // ‡∏´‡∏≤ teacher ‡∏à‡∏≤‡∏Å records
        const rec = state.records.find(r => (r.code+' '+(r.name||r.subjectName||'')) === subj);
        const teacher = rec ? rec.teacher : '';
        return `<tr>
          <td style="text-align:center"><span class="rank-badge ${rc}">${rank}</span></td>
          <td><strong>${subj}</strong>${teacher?`<div style="font-size:0.78rem;color:var(--text-muted)">üë®‚Äçüè´ ${teacher}</div>`:''}</td>
          <td style="text-align:center"><span class="freq-badge freq-high">${cnt} ‡∏Ñ‡∏ô</span></td>
        </tr>`;
      }).join('')}</tbody>
    </table>`;
  }

  // Top 5 ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (‡∏ô‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ã‡πâ‡∏≥)
  const studentMap = {};
  ms.forEach(s => {
    const key = `${s.prefix}${s.fullname}`.trim();
    if (!studentMap[key]) studentMap[key] = { name: `${s.prefix} ${s.fullname}`.trim(), count: 0, subjects: [] };
    studentMap[key].count++;
    studentMap[key].subjects.push(s.code);
  });
  const top5stu = Object.values(studentMap).sort((a,b) => b.count-a.count).slice(0,5);
  const stuEl = document.getElementById('top5-students');
  if (!top5stu.length) { stuEl.innerHTML = '<div class="empty-state" style="padding:20px"><p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p></div>'; }
  else {
    stuEl.innerHTML = `<table class="top5-table">
      <thead><tr><th style="width:36px">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</th><th>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th><th style="width:80px;text-align:center">‡∏ï‡∏¥‡∏î ‡∏°‡∏™.</th></tr></thead>
      <tbody>${top5stu.map((s, i) => {
        const rank = i+1;
        const rc = rank===1?'rank-1':rank===2?'rank-2':rank===3?'rank-3':'rank-other';
        const freqCls = s.count >= 4 ? 'freq-high' : s.count >= 2 ? 'freq-mid' : 'freq-low';
        return `<tr>
          <td style="text-align:center"><span class="rank-badge ${rc}">${rank}</span></td>
          <td><strong>${s.name}</strong><div style="font-size:0.78rem;color:var(--text-muted)">${s.subjects.join(', ')}</div></td>
          <td style="text-align:center"><span class="freq-badge ${freqCls}">${s.count} ‡∏ß‡∏¥‡∏ä‡∏≤</span></td>
        </tr>`;
      }).join('')}</tbody>
    </table>`;
  }
}

// ============================================================
// STUDENT FREQUENCY TABLE (Print Tab)
// ============================================================
function getStudentFreqData() {
  const map = {};
  state.records.forEach(r => {
    r.students.forEach(s => {
      const key = `${s.prefix}${s.fullname}`.trim();
      if (!map[key]) map[key] = { prefix: s.prefix, fullname: s.fullname, count: 0, entries: [] };
      map[key].count++;
      map[key].entries.push({ code: r.code, subjectName: r.name || r.subjectName || '', teacher: r.teacher, level: r.level });
    });
  });
  return Object.values(map).sort((a,b) => {
    if (b.count !== a.count) return b.count - a.count;
    return a.fullname.localeCompare(b.fullname, 'th');
  });
}

function renderStudentFreqTable() {
  const wrap = document.getElementById('student-freq-table-wrap');
  if (!wrap) return;
  const search = (document.getElementById('student-table-search')?.value || '').trim().toLowerCase();
  let data = getStudentFreqData();
  if (search) data = data.filter(d => `${d.prefix}${d.fullname}`.toLowerCase().includes(search));

  if (!data.length) {
    wrap.innerHTML = '<div class="empty-state"><div class="icon">üì≠</div><p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p></div>';
    return;
  }

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á expand-on-click
  wrap.innerHTML = `
    <div style="font-size:0.8rem;color:var(--text-muted);margin-bottom:8px;">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${data.length} ‡∏Ñ‡∏ô | ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÅ‡∏ñ‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ß‡∏¥‡∏ä‡∏≤</div>
    <table class="ms-student-table">
      <thead><tr>
        <th style="width:36px">#</th>
        <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
        <th style="width:80px;text-align:center">‡∏ï‡∏¥‡∏î ‡∏°‡∏™.</th>
        <th>‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤</th>
      </tr></thead>
      <tbody>
        ${data.map((d, i) => {
          const freqCls = d.count >= 4 ? 'freq-high' : d.count >= 2 ? 'freq-mid' : 'freq-low';
          const subjectList = d.entries.map(e =>
            `<span style="display:inline-block;background:#e0f2fe;color:#0f3d7a;border-radius:4px;padding:1px 7px;margin:2px 2px;font-size:0.77rem;">
              ${e.code} ${e.subjectName} <span style="opacity:0.7;">(${e.teacher})</span>
            </span>`
          ).join('');
          return `<tr>
            <td style="text-align:center;color:var(--text-muted);font-size:0.8rem;">${i+1}</td>
            <td><strong>${d.prefix} ${d.fullname}</strong></td>
            <td style="text-align:center"><span class="freq-badge ${freqCls}">${d.count} ‡∏ß‡∏¥‡∏ä‡∏≤</span></td>
            <td style="line-height:1.8;">${subjectList}</td>
          </tr>`;
        }).join('')}
      </tbody>
    </table>`;
}

function buildChart(canvasId, dataMap) {
  const ctx = document.getElementById(canvasId); if (!ctx) return null;
  const labels = Object.keys(dataMap), data = Object.values(dataMap);
  return new Chart(ctx, {
    type: 'bar',
    data: { labels, datasets: [{ data, backgroundColor: labels.map((_,i)=>`hsla(${210+i*22},75%,55%,0.8)`), borderColor: labels.map((_,i)=>`hsla(${210+i*22},75%,42%,1)`), borderWidth: 1.5, borderRadius: 6 }] },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { font: { family: 'Sarabun' } }, grid: { color: '#e2eaf5' } }, x: { ticks: { font: { family: 'Sarabun', size: 11 } }, grid: { display: false } } } }
  });
}

// ============================================================
// PRINT
// ============================================================
function generatePrintPreview() {
  const schoolTotal = TOTAL_STUDENTS;
  const msCount     = state.records.reduce((a,r) => a + r.students.length, 0);
  const pctMs       = (msCount / schoolTotal * 100).toFixed(1);
  const dateStr     = new Date().toLocaleDateString('th-TH',{year:'numeric',month:'long',day:'numeric'});

  // ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const headerHtml = `
    <div style="text-align:center;margin-bottom:20px;padding-bottom:14px;border-bottom:2px solid #1a56a8;">
      <img src="https://nonthaphathr.github.io/uploadimg/logoschool.png" style="height:64px;margin-bottom:6px;" onerror="this.style.display='none'">
      <h2 style="font-size:1.15rem;color:#1a56a8;margin:0;">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏∂‡∏á‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞ 80</h2>
      <p style="font-size:0.85rem;color:#5a7099;margin-top:3px;">‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ${state.year} | ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡∏£‡∏∞‡∏î‡∏∏‡∏°‡∏ó‡∏≠‡∏á‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤ | ${dateStr}</p>
    </div>`;

  // ‚îÄ‚îÄ STATS SUMMARY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const summaryHtml = `
    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:22px;">
      ${[['‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î',state.records.length,'#1a56a8'],
         ['‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô',schoolTotal,'#0f3d7a'],
         ['‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ‡∏°‡∏™.',msCount,'#ef4444'],
         ['‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞ ‡∏°‡∏™.',pctMs+'%','#f59e0b']]
        .map(([l,v,c])=>`<div style="background:#f0f6ff;border:1px solid #c7d9f5;border-radius:8px;padding:12px;text-align:center;">
          <div style="font-size:1.7rem;font-weight:700;color:${c};">${v}</div>
          <div style="font-size:0.78rem;color:#5a7099;">${l}</div>
        </div>`).join('')}
    </div>`;

  // ‚îÄ‚îÄ PAGE 1: ‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let page1 = '';
  state.records.forEach(r => {
    if (!r.students.length) return;
    page1 += `
      <div style="margin-bottom:18px;border:1px solid #c7d9f5;border-radius:8px;overflow:hidden;break-inside:avoid;">
        <div style="background:linear-gradient(135deg,#0f3d7a,#1a56a8);color:#fff;padding:9px 14px;display:flex;justify-content:space-between;align-items:center;">
          <span><strong>${r.code} ${r.name||r.subjectName||''}</strong>
            <span style="font-size:0.8rem;opacity:0.85;margin-left:10px;">${r.level} | ${r.teacher} | ${r.group}</span>
          </span>
          <span style="background:#ef4444;padding:2px 10px;border-radius:10px;font-size:0.8rem;white-space:nowrap;">‡∏°‡∏™. ${r.students.length} ‡∏Ñ‡∏ô</span>
        </div>
        <table style="width:100%;border-collapse:collapse;font-size:0.83rem;">
          <thead><tr style="background:#e0f2fe;">
            <th style="padding:6px 10px;border-bottom:1px solid #c7d9f5;text-align:center;width:36px">#</th>
            <th style="padding:6px 10px;border-bottom:1px solid #c7d9f5;">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
            <th style="padding:6px 10px;border-bottom:1px solid #c7d9f5;text-align:center;width:70px">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
          </tr></thead>
          <tbody>${r.students.map((s,i)=>`
            <tr style="background:${i%2===0?'#fff':'#f8faff'}">
              <td style="padding:6px 10px;border-bottom:1px solid #f0f6ff;text-align:center;">${i+1}</td>
              <td style="padding:6px 10px;border-bottom:1px solid #f0f6ff;">${s.prefix} ${s.fullname}</td>
              <td style="padding:6px 10px;border-bottom:1px solid #f0f6ff;text-align:center;">
                <span style="background:#fee2e2;color:#991b1b;padding:2px 8px;border-radius:10px;font-weight:600;font-size:0.78rem;">‡∏°‡∏™.</span>
              </td>
            </tr>`).join('')}
          </tbody>
        </table>
      </div>`;
  });

  // ‚îÄ‚îÄ PAGE 2: ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏ß‡∏° (‡∏ô‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const freqData = getStudentFreqData();
  const page2Header = `
    <div style="page-break-before:always;padding-top:8px;">
      <div style="text-align:center;margin-bottom:16px;padding-bottom:12px;border-bottom:2px solid #1a56a8;">
        <h2 style="font-size:1.1rem;color:#1a56a8;margin:0;">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î ‡∏°‡∏™. ‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤</h2>
        <p style="font-size:0.82rem;color:#5a7099;margin-top:3px;">‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ${state.year} | ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏¥‡∏î ‡∏°‡∏™. ‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô ${freqData.length} ‡∏Ñ‡∏ô</p>
      </div>`;

  const freqTableRows = freqData.map((d, i) => {
    const freqColor = d.count >= 4 ? '#991b1b' : d.count >= 2 ? '#92400e' : '#065f46';
    const freqBg    = d.count >= 4 ? '#fee2e2' : d.count >= 2 ? '#fef9c3' : '#d1fae5';
    const subjectList = d.entries.map(e =>
      `<span style="display:inline-block;background:#e0f2fe;color:#0f3d7a;border-radius:3px;padding:1px 6px;margin:1px 2px;font-size:0.75rem;">${e.code} ${e.subjectName} <span style="opacity:0.65;">(${e.teacher})</span></span>`
    ).join('');
    return `<tr style="background:${i%2===0?'#fff':'#f8faff'}">
      <td style="padding:6px 10px;border-bottom:1px solid #f0f6ff;text-align:center;color:#5a7099;font-size:0.8rem;">${i+1}</td>
      <td style="padding:6px 10px;border-bottom:1px solid #f0f6ff;font-weight:600;">${d.prefix} ${d.fullname}</td>
      <td style="padding:6px 10px;border-bottom:1px solid #f0f6ff;text-align:center;">
        <span style="background:${freqBg};color:${freqColor};padding:2px 10px;border-radius:10px;font-weight:700;font-size:0.82rem;">${d.count} ‡∏ß‡∏¥‡∏ä‡∏≤</span>
      </td>
      <td style="padding:6px 10px;border-bottom:1px solid #f0f6ff;line-height:1.7;">${subjectList}</td>
    </tr>`;
  }).join('');

  const freqTable = `
      <table style="width:100%;border-collapse:collapse;font-size:0.83rem;">
        <thead><tr style="background:linear-gradient(135deg,#0f3d7a,#1a56a8);color:#fff;">
          <th style="padding:8px 10px;text-align:center;width:36px">#</th>
          <th style="padding:8px 10px;">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
          <th style="padding:8px 10px;text-align:center;width:80px">‡∏ï‡∏¥‡∏î ‡∏°‡∏™.</th>
          <th style="padding:8px 10px;">‡∏£‡∏≤‡∏¢‡∏ß‡∏¥‡∏ä‡∏≤ (‡∏£‡∏´‡∏±‡∏™ ‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤ ‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô)</th>
        </tr></thead>
        <tbody>${freqTableRows}</tbody>
      </table>
    </div>`;

  // ‚îÄ‚îÄ FOOTER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const footer = `<div style="text-align:right;font-size:0.78rem;color:#5a7099;margin-top:18px;padding-top:10px;border-top:1px solid #e2eaf5;">
    ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÇ‡∏î‡∏¢: ‡∏Ñ‡∏£‡∏π‡∏¢‡∏∏‡∏û‡∏≤ ‡∏ó‡∏≠‡∏á‡∏Ñ‡∏≥ | ‡∏á‡∏≤‡∏ô‡∏ß‡∏±‡∏î‡∏ú‡∏•‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ú‡∏• | ${dateStr}
  </div>`;

  const html = `<div style="font-family:'Sarabun',sans-serif;color:#1e2d4a;max-width:900px;margin:0 auto;">
    ${headerHtml}${summaryHtml}${page1}${page2Header}${freqTable}${footer}
  </div>`;

  document.getElementById('print-preview-area').innerHTML = html;
}

function printDoc() {
  generatePrintPreview();
  const content = document.getElementById('print-preview-area').innerHTML;
  const win = window.open('', '_blank');
  win.document.write(`<!DOCTYPE html><html lang="th"><head>
    <meta charset="UTF-8">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600;700&display=swap" rel="stylesheet">
    <title>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô ‡∏°‡∏™. ‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ${state.year}</title>
    <style>
      body { font-family:'Sarabun',sans-serif; padding:16px; color:#1e2d4a; }
      @media print {
        @page { margin:12mm; size:A4; }
        body { padding:0; }
        .page-break { page-break-before:always; }
      }
    </style>
  </head><body>${content}<script>window.onload=()=>window.print();<\/script></body></html>`);
  win.document.close();
}

// ============================================================
// EXPORT
// ============================================================
function exportExcel() {
  const wb = XLSX.utils.book_new();
  const summary = [['‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏¥‡∏ä‡∏≤','‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤','‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞','‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô','‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô','‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ‡∏°‡∏™. (‡∏Ñ‡∏ô)']];
  const schoolTotalEx = TOTAL_STUDENTS;
  const totalMsEx = state.records.reduce((a,r) => a + r.students.length, 0);
  state.records.forEach(r => {
    summary.push([r.code,r.name||r.subjectName||'',r.group,r.level,r.teacher,r.students.length]);
  });
  // footer row
  summary.push(['','','','','‡∏£‡∏ß‡∏° ‡∏°‡∏™. ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î',totalMsEx,'','‡∏£‡πâ‡∏≠‡∏¢‡∏•‡∏∞',(schoolTotalEx>0?(totalMsEx/schoolTotalEx*100).toFixed(1)+'%':'-')]);
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(summary), '‡∏™‡∏£‡∏∏‡∏õ');
  const detail = [['‡∏£‡∏´‡∏±‡∏™‡∏ß‡∏¥‡∏ä‡∏≤','‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡∏¥‡∏ä‡∏≤','‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏™‡∏≤‡∏£‡∏∞','‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô','‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏™‡∏≠‡∏ô','‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤','‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•','‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞']];
  state.records.forEach(r => r.students.forEach(s => {
    detail.push([r.code,r.name||r.subjectName||'',r.group,r.level,r.teacher,s.prefix,s.fullname,'‡∏°‡∏™.']);
  }));
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(detail), '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î');
  XLSX.writeFile(wb, `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô_‡∏°‡∏™_‡∏õ‡∏µ${state.year}.xlsx`);
  showToast('Export Excel ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üìä', 'success');
}
function exportJSON() {
  const blob = new Blob([JSON.stringify({ records: state.records, year: state.year }, null, 2)], { type: 'application/json' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
  a.download = `ms-backup-${Date.now()}.json`; a.click();
  showToast('Backup JSON ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
}
function importJSON() { document.getElementById('import-file').click(); }
function handleImport(input) {
  const file = input.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const data = JSON.parse(e.target.result);
      if (data.records) {
        state.records = data.records;
        localStorage.setItem('ms-records-cache', JSON.stringify(state.records));
        renderRecordList(); showToast('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
      } else showToast('‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
    } catch { showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ', 'error'); }
  };
  reader.readAsText(file); input.value = '';
}

// ============================================================
// UI HELPERS
// ============================================================
function setSyncState(s, label) {
  const dot = document.getElementById('sync-dot');
  const lbl = document.getElementById('sync-label');
  if (!dot) return;
  dot.className = 'sync-dot' + (s==='loading'?' loading':s==='error'?' error':'');
  if (lbl) lbl.textContent = label;
}
function showLoading(msg = '') { document.getElementById('loading-overlay').style.display = 'flex'; document.getElementById('loading-msg').textContent = msg; }
function hideLoading() { document.getElementById('loading-overlay').style.display = 'none'; }

let toastTimer;
function showToast(msg, type = '') {
  const t = document.getElementById('toast');
  t.textContent = msg; t.className = 'toast show ' + type;
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 3500);
}

// ============================================================
// START
// ============================================================
init();
</script>
</body>
</html>
