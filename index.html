// ============================================================
// Google Apps Script - ระบบสำรวจข้อมูลนักเรียน มส.
// โรงเรียนกระดุมทองวิทยา | ครูยุพา ทองคำ
// ============================================================
// ⚠️ ทุก action ส่งผ่าน GET (JSONP) เพื่อหลีกเลี่ยง CORS
//
// Column Structure (Sheet: รายชื่อ):
//   A: Timestamp      B: ปีการศึกษา    C: ครูผู้สอน
//   D: กลุ่มสาระ      E: รหัสวิชา      F: ชื่อวิชา
//   G: ระดับชั้น      H: คำนำหน้า      I: ชื่อ-สกุล
//   J: เวลามาเรียน    K: เวลาทั้งหมด   L: ร้อยละ
//   M: สถานะ          N: recordId
//
// Sheet: ชื่อครูในระบบ — คอลัมน์ A "ชื่อครู" (row 1 = header)
// Sheet: ตั้งค่า       — เก็บ key/value (groups, year, totalStudents)
//
// วิธี Deploy:
//   Deploy > New deployment > Web App
//   Execute as: Me  |  Access: Anyone
// ============================================================

const SHEET_ID      = '1vuhBRUML7g4TLxfGjDVlq-8zw2RSr-FweO_f9xsY1v0';
const SHEET_NAME    = 'รายชื่อ';
const SETTINGS_NAME = 'ตั้งค่า';
const TEACHERS_NAME = 'ชื่อครูในระบบ';
const TOTAL_COLS    = 14;

const COL = {
  timestamp: 1, year: 2, teacher: 3, group: 4,
  code: 5, subjectName: 6, level: 7, prefix: 8,
  fullname: 9, attended: 10, total: 11,
  pct: 12, status: 13, recordId: 14
};

// ============================================================
// JSONP RESPONSE
// ============================================================
function outJsonp(e, data) {
  const cb = (e.parameter && e.parameter.callback) || 'callback';
  return ContentService
    .createTextOutput(cb + '(' + JSON.stringify(data) + ')')
    .setMimeType(ContentService.MimeType.JAVASCRIPT);
}

// ============================================================
// doGet — รับทุก action
// ============================================================
function doGet(e) {
  try {
    const p      = e.parameter || {};
    const action = p.action || 'getAll';

    if (action === 'ping')         return outJsonp(e, { ok: true, time: new Date().toISOString() });
    if (action === 'getAll')       return outJsonp(e, getAllRecords());
    if (action === 'getTeachers')  return outJsonp(e, getTeachers());
    if (action === 'getSettings')  return outJsonp(e, getSettings());
    if (action === 'saveSettings') {
      const settings = JSON.parse(decodeURIComponent(p.settings));
      return outJsonp(e, saveSettings(settings));
    }
    if (action === 'saveRecord') {
      const record = JSON.parse(decodeURIComponent(p.record));
      return outJsonp(e, saveRecord(record));
    }
    if (action === 'updateRecord') {
      const record = JSON.parse(decodeURIComponent(p.record));
      return outJsonp(e, updateRecord(record));
    }
    if (action === 'deleteRecord') {
      return outJsonp(e, deleteRecord(decodeURIComponent(p.recordId)));
    }
    return outJsonp(e, { error: 'Unknown action: ' + action });
  } catch(err) {
    return outJsonp(e, { error: err.message, stack: err.stack });
  }
}

function doPost(e) { return doGet(e); }

// ============================================================
// HELPERS
// ============================================================
function getSheet() {
  return SpreadsheetApp.openById(SHEET_ID).getSheetByName(SHEET_NAME);
}

function getSettingsSheet() {
  const ss = SpreadsheetApp.openById(SHEET_ID);
  let sh = ss.getSheetByName(SETTINGS_NAME);
  if (!sh) {
    sh = ss.insertSheet(SETTINGS_NAME);
    sh.getRange(1,1,1,2).setValues([['key','value']]);
    sh.getRange(1,1,1,2).setBackground('#1a56a8').setFontColor('#fff').setFontWeight('bold');
  }
  return sh;
}

function ensureRecordIdHeader(sh) {
  if (String(sh.getRange(1, COL.recordId).getValue()).trim() !== 'recordId') {
    sh.getRange(1, COL.recordId).setValue('recordId')
      .setBackground('#1a56a8').setFontColor('#ffffff').setFontWeight('bold');
  }
}

function calcPct(attended, total) {
  if (!total || total <= 0) return '';
  return Math.round(attended / total * 10000) / 100;
}

function calcStatus(attended, total) {
  if (!total || total <= 0) return '-';
  return (attended / total * 100) < 80 ? 'มส.' : 'ผ่าน';
}

function nowTH() {
  return Utilities.formatDate(new Date(), 'Asia/Bangkok', "yyyy-MM-dd'T'HH:mm:ss");
}

// ============================================================
// GET TEACHERS — ดึงจาก Sheet "ชื่อครูในระบบ" คอลัมน์ A
// ============================================================
function getTeachers() {
  try {
    const ss = SpreadsheetApp.openById(SHEET_ID);
    const sh = ss.getSheetByName(TEACHERS_NAME);
    if (!sh) return { ok: false, error: 'ไม่พบ Sheet "' + TEACHERS_NAME + '"' };

    const lastRow = sh.getLastRow();
    if (lastRow < 2) return { ok: true, teachers: [] };

    // คอลัมน์ A ตั้งแต่ row 2 (row 1 = header "ชื่อครู")
    const values = sh.getRange(2, 1, lastRow - 1, 1).getValues();
    const teachers = values
      .map(function(r) { return String(r[0] || '').trim(); })
      .filter(function(v) { return v !== ''; });

    return { ok: true, teachers: teachers };
  } catch(err) {
    return { ok: false, error: err.message };
  }
}

// ============================================================
// SETTINGS — อ่าน/เขียน sheet ตั้งค่า (groups, year, totalStudents)
// ============================================================
function getSettings() {
  try {
    const sh = getSettingsSheet();
    const lastRow = sh.getLastRow();
    if (lastRow < 2) return { ok: true, settings: {} };
    const data = sh.getRange(2, 1, lastRow - 1, 2).getValues();
    const settings = {};
    data.forEach(function(row) {
      const k = String(row[0] || '').trim();
      const v = String(row[1] || '').trim();
      if (k) {
        try { settings[k] = JSON.parse(v); } catch(e) { settings[k] = v; }
      }
    });
    return { ok: true, settings: settings };
  } catch(err) {
    return { ok: false, error: err.message };
  }
}

function saveSettings(settings) {
  try {
    const sh = getSettingsSheet();
    const lastRow = sh.getLastRow();
    if (lastRow >= 2) sh.getRange(2, 1, lastRow - 1, 2).clearContent();
    const rows = [];
    Object.keys(settings).forEach(function(k) {
      const v = settings[k];
      rows.push([k, typeof v === 'object' ? JSON.stringify(v) : String(v)]);
    });
    if (rows.length > 0) sh.getRange(2, 1, rows.length, 2).setValues(rows);
    return { ok: true };
  } catch(err) {
    return { ok: false, error: err.message };
  }
}

// ============================================================
// GET ALL RECORDS
// ============================================================
function getAllRecords() {
  const sh      = getSheet();
  const lastRow = sh.getLastRow();
  if (lastRow < 2) return { ok: true, records: [] };

  const numCols = Math.max(sh.getLastColumn(), TOTAL_COLS);
  const data    = sh.getRange(2, 1, lastRow - 1, numCols).getValues();
  const recordMap = {}, recordOrder = [];

  data.forEach(function(row) {
    const teacher  = String(row[COL.teacher - 1]  || '').trim();
    const code     = String(row[COL.code - 1]     || '').trim();
    if (!teacher && !code) return;

    const year     = String(row[COL.year - 1]        || '').trim();
    const group    = String(row[COL.group - 1]       || '').trim();
    const name     = String(row[COL.subjectName - 1] || '').trim();
    const level    = String(row[COL.level - 1]       || '').trim();
    const prefix   = String(row[COL.prefix - 1]      || '').trim();
    const fullname = String(row[COL.fullname - 1]    || '').trim();
    const attended = parseFloat(row[COL.attended - 1]) || 0;
    const total    = parseFloat(row[COL.total - 1])    || 0;
    const recId    = String(row[COL.recordId - 1]    || '').trim();
    const key      = recId || [year, teacher, code, level].join('|');

    if (!recordMap[key]) {
      recordMap[key] = { id: key, year, teacher, group, code, name, level, students: [] };
      recordOrder.push(key);
    }
    if (fullname || attended || total) {
      recordMap[key].students.push({ prefix, fullname, attended, total });
    }
  });

  return { ok: true, records: recordOrder.map(function(k) { return recordMap[k]; }) };
}

// ============================================================
// SAVE
// ============================================================
function saveRecord(record) {
  const sh = getSheet();
  ensureRecordIdHeader(sh);
  const ts   = nowTH();
  const rows = record.students.map(function(s) {
    return [
      ts, record.year, record.teacher, record.group,
      record.code, record.name, record.level,
      s.prefix, s.fullname, s.attended, s.total,
      calcPct(s.attended, s.total),
      calcStatus(s.attended, s.total),
      record.id
    ];
  });
  if (rows.length > 0) {
    sh.getRange(sh.getLastRow() + 1, 1, rows.length, TOTAL_COLS).setValues(rows);
  }
  return { ok: true, recordId: record.id, rowsAdded: rows.length };
}

// ============================================================
// UPDATE
// ============================================================
function updateRecord(record) {
  const sh      = getSheet();
  const lastRow = sh.getLastRow();
  if (lastRow >= 2) {
    ensureRecordIdHeader(sh);
    const colN     = sh.getRange(2, COL.recordId, lastRow - 1, 1).getValues();
    const toDelete = [];
    colN.forEach(function(row, idx) {
      if (String(row[0] || '').trim() === String(record.id)) toDelete.push(idx + 2);
    });
    if (toDelete.length === 0) {
      sh.getRange(2, 1, lastRow - 1, 13).getValues().forEach(function(row, idx) {
        var legKey = [
          String(row[COL.year-1]||'').trim(), String(row[COL.teacher-1]||'').trim(),
          String(row[COL.code-1]||'').trim(),  String(row[COL.level-1]||'').trim()
        ].join('|');
        if (legKey === String(record.id)) toDelete.push(idx + 2);
      });
    }
    toDelete.sort(function(a,b){ return b-a; }).forEach(function(r) { sh.deleteRow(r); });
  }
  return saveRecord(record);
}

// ============================================================
// DELETE
// ============================================================
function deleteRecord(recordId) {
  const sh      = getSheet();
  const lastRow = sh.getLastRow();
  if (lastRow < 2) return { ok: true, rowsDeleted: 0 };

  const colN     = sh.getRange(2, COL.recordId, lastRow - 1, 1).getValues();
  const toDelete = [];
  colN.forEach(function(row, idx) {
    if (String(row[0] || '').trim() === String(recordId)) toDelete.push(idx + 2);
  });
  if (toDelete.length === 0) {
    sh.getRange(2, 1, lastRow - 1, 13).getValues().forEach(function(row, idx) {
      var legKey = [
        String(row[COL.year-1]||'').trim(), String(row[COL.teacher-1]||'').trim(),
        String(row[COL.code-1]||'').trim(),  String(row[COL.level-1]||'').trim()
      ].join('|');
      if (legKey === String(recordId)) toDelete.push(idx + 2);
    });
  }
  toDelete.sort(function(a,b){ return b-a; }).forEach(function(r) { sh.deleteRow(r); });
  return { ok: true, recordId, rowsDeleted: toDelete.length };
}
